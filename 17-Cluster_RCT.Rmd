# Cluster Randomised Control Trials

```{r packages16, echo=F, message=F, warning=F}
list_of_packages<-c("tidyverse","diagram","ggpubr","ggalluvial","DiagrammeR","DiagrammeRsvg","rsvg", "knitr", "kableExtra")
new.packages <- list_of_packages[!(list_of_packages %in% installed.packages()[,"Package"])]
if(length(new.packages))install.packages(new.packages,dependencies = TRUE)

library(tidyverse)
library(ggpubr)
library(ggalluvial)
library(diagram)

library(DiagrammeR)
library(DiagrammeRsvg)
library(magrittr)
library(rsvg)

library(kableExtra)
library(knitr)
library(citr)
```

## What is a cluster RCT? 

In some situations, allocation of intervention can be problematic due to pragmatic constraints; for example, schools can find spliting students within each class into an intervention and control groups to be very disruptive; or perhaps therapists may find it difficult to assign individuals to intervention following a preset scheme as the intervention may be very obvious compared to control, so randomisation is compromised (in many medical clinical trials, randomisation can be simpler due to the use blinding because placebo treatments can be designed to appear identical). A potential solution is to use cluster trials as the allocation to intervention is by group, typically referred to as cluster. We can designate clusters that would naturally form together, for example, school classes, patients under the care of a particular medical practice, or maybe all patients seen by a specific therapist.

```{r, cluster_diag,echo=FALSE,warning=F,message=F}
library(ggplot2)
library(ggimage)
library(maptools)

# create a df

set.seed(1)

data(wrld_simpl)
world <- fortify(wrld_simpl)
worldUk <- subset(world, id=="GBR")

d <- data.frame(x = seq(-3,0,0.2),
                y = rnorm(length(seq(-3,0,0.2)),52.5,0.5),
                image = 'stickman.png')

d$x2<-d$x+12
worldUk$long2<-worldUk$long+12
d$cluster<-as.factor(rep(1:4,each=4))

polys<-data.frame(id=rep(1:4,each=4),x=c(2,-2,-2,2,-3,-7,-7,-3,9,5,5,9,14,10,10,14),y=c(43,43,48,48,43,43,48,48,43,43,48,48,43,43,48,48))

d2 <- data.frame(x = c(-6.5,-5.5,-4.5,-3.5,-1.5,-0.5,0.5,1.5,-6.5,-5.5,-4.5,-3.5,-1.5,-0.5,0.5,1.5),
                y = c(44,44,44,44,44,44,44,44,47,47,47,47,47,47,47,47),
                image = 'stickman.png')

d2$x2<-d2$x+12
d2$cluster<-as.factor(rep(1:4,each=4))

df<-data.frame(x2=c(-4,-2,8,10.5),x1=c(-1.5,-1.5,9.5,9.5),y1=c(51,51,51,51),y2=c(48.5,48.5,48.5,48.5))

# plot2
ggplot() + geom_path(aes(long, lat, group=group), data=worldUk, color="grey", fill=NA) + geom_path(aes(long2, lat, group=group), data=worldUk, color="grey", fill=NA)+coord_equal() + geom_image(data=d,aes(x=x,y=y,image=image), size=.012,color="blue") + geom_image(data=d,aes(x=x2,y=y,image=image,colour=cluster), size=.012) + xlim(-10,15) + ylim(42,61) + geom_polygon(data=polys,aes(x=x,y=y,group=id),colour="black",fill='white') + geom_image(data=d2,aes(x=x,y=y,image=image), size=.012,color="blue") + geom_image(data=d2,aes(x=x2,y=y,image=image,colour=cluster), size=.012) + annotate(geom="text",x=-5.5, y=49, label="Control")+ annotate(geom="text",x=0.5, y=49, label="Treatment")+ annotate(geom="text",x=6.5, y=49, label="Control")+ annotate(geom="text",x=12.5, y=49, label="Treatment")+geom_segment(aes(x = x1, y = y1, xend = x2, yend = y2),colour="red",arrow = arrow(length = unit(0.03, "npc")), data = df)+ annotate(geom="text",x=8.4, y=61, label="CLUSTER RCT") + annotate(geom="text",x=-3.7, y=61, label="INDIVIDUAL RCT")+ theme_nothing()+ theme(legend.position = "none")
```

## Advanced design: Stepped-wedge Cluster RCT